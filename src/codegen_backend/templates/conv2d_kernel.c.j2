{{ signature }}
    int64_t in_per_group = {{ in_channels }} / {{ groups }};
    int64_t out_per_group = {{ out_channels }} / {{ groups }};
    int64_t out_pad_h = {{ out_pad_h }};
    int64_t out_pad_w = {{ out_pad_w }};
    (void)out_pad_h;
    (void)out_pad_w;
    {% if has_batch %}
    for (size_t n = 0; n < {{ batch }}; ++n) {
        for (size_t oc = 0; oc < {{ out_channels }}; ++oc) {
            int64_t group = (int64_t)oc / out_per_group;
            for (size_t oh = 0; oh < {{ out_h }}; ++oh) {
                for (size_t ow = 0; ow < {{ out_w }}; ++ow) {
                    {{ c_type }} acc = 0.0f;
                    int64_t in_h_base = (int64_t)oh * {{ stride_h }} - {{ pad_h }};
                    int64_t in_w_base = (int64_t)ow * {{ stride_w }} - {{ pad_w }};
                    for (size_t ic = 0; ic < in_per_group; ++ic) {
                        int64_t in_c = group * in_per_group + (int64_t)ic;
                        for (size_t kh = 0; kh < {{ k_h }}; ++kh) {
                            int64_t in_h_idx = in_h_base + (int64_t)kh * {{ dil_h }};
                            if (in_h_idx < 0 || in_h_idx >= {{ in_h }}) {
                                continue;
                            }
                            for (size_t kw = 0; kw < {{ k_w }}; ++kw) {
                                int64_t in_w_idx = in_w_base + (int64_t)kw * {{ dil_w }};
                                if (in_w_idx < 0 || in_w_idx >= {{ in_w }}) {
                                    continue;
                                }
                                acc += {{ input_access }} * {{ weight_access }};
                            }
                        }
                    }
                    {% if has_bias %}
                    acc += bias[oc];
                    {% endif %}
                    out[n][oc][oh][ow] = acc;
                }
            }
        }
    }
    {% else %}
    for (size_t oc = 0; oc < {{ out_channels }}; ++oc) {
        int64_t group = (int64_t)oc / out_per_group;
        for (size_t oh = 0; oh < {{ out_h }}; ++oh) {
            for (size_t ow = 0; ow < {{ out_w }}; ++ow) {
                {{ c_type }} acc = 0.0f;
                int64_t in_h_base = (int64_t)oh * {{ stride_h }} - {{ pad_h }};
                int64_t in_w_base = (int64_t)ow * {{ stride_w }} - {{ pad_w }};
                for (size_t ic = 0; ic < in_per_group; ++ic) {
                    int64_t in_c = group * in_per_group + (int64_t)ic;
                    for (size_t kh = 0; kh < {{ k_h }}; ++kh) {
                        int64_t in_h_idx = in_h_base + (int64_t)kh * {{ dil_h }};
                        if (in_h_idx < 0 || in_h_idx >= {{ in_h }}) {
                            continue;
                        }
                        for (size_t kw = 0; kw < {{ k_w }}; ++kw) {
                            int64_t in_w_idx = in_w_base + (int64_t)kw * {{ dil_w }};
                            if (in_w_idx < 0 || in_w_idx >= {{ in_w }}) {
                                continue;
                            }
                            acc += {{ input_access }} * {{ weight_access }};
                        }
                    }
                }
                {% if has_bias %}
                acc += bias[oc];
                {% endif %}
                out[oc][oh][ow] = acc;
            }
        }
    }
    {% endif %}
}
