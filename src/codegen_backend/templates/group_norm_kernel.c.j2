{{ signature }}
    const int64_t batch = {{ batch }};
    const int64_t channels = {{ channels }};
    const int64_t spatial = {{ spatial_size }};
    const int64_t groups = {{ groups }};
    const int64_t channels_per_group = channels / groups;
    const {{ c_type }} *input_ptr = &input{{ input_zero_indices }};
    {{ c_type }} *out_ptr = &out{{ output_zero_indices }};
{% if has_weight %}
    const {{ c_type }} *weight_ptr = &weight{{ weight_zero_indices }};
{% endif %}
{% if has_bias %}
    const {{ c_type }} *bias_ptr = &bias{{ bias_zero_indices }};
{% endif %}
    for (size_t n = 0; n < batch; ++n) {
        for (size_t g = 0; g < groups; ++g) {
            const int64_t c_start = g * channels_per_group;
            const int64_t group_offset = (n * channels + c_start) * spatial;
            {{ c_type }} mean = 0;
            for (size_t c = 0; c < channels_per_group; ++c) {
                const int64_t base = group_offset + c * spatial;
                for (size_t s = 0; s < spatial; ++s) {
                    mean += input_ptr[base + s];
                }
            }
            const {{ c_type }} group_size = ({{ c_type }})(channels_per_group * spatial);
            mean /= group_size;
            {{ c_type }} var = 0;
            for (size_t c = 0; c < channels_per_group; ++c) {
                const int64_t base = group_offset + c * spatial;
                for (size_t s = 0; s < spatial; ++s) {
                    {{ c_type }} diff = input_ptr[base + s] - mean;
                    var += diff * diff;
                }
            }
            var /= group_size;
            {{ c_type }} rstd = ({{ c_type }})1 / {{ sqrt_fn }}(var + {{ eps }});
            for (size_t c = 0; c < channels_per_group; ++c) {
                const int64_t channel = c_start + c;
{% if has_weight %}
                {{ c_type }} w = weight_ptr[channel];
{% else %}
                {{ c_type }} w = 1;
{% endif %}
{% if has_bias %}
                {{ c_type }} b = bias_ptr[channel];
{% else %}
                {{ c_type }} b = 0;
{% endif %}
                const int64_t base = (n * channels + channel) * spatial;
                for (size_t s = 0; s < spatial; ++s) {
                    {{ c_type }} val = (input_ptr[base + s] - mean) * rstd;
                    out_ptr[base + s] = val * w + b;
                }
            }
        }
    }
}
