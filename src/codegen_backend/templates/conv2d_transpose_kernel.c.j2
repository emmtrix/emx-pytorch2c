{{ signature }}
    int64_t in_per_group = {{ in_channels }} / {{ groups }};
    int64_t out_per_group = {{ out_channels }} / {{ groups }};
    {% if has_batch %}
    for (int64_t n = 0; n < {{ batch }}; ++n) {
        for (int64_t oc = 0; oc < {{ out_channels }}; ++oc) {
            for (int64_t oh = 0; oh < {{ out_h }}; ++oh) {
                for (int64_t ow = 0; ow < {{ out_w }}; ++ow) {
                    {% if has_bias %}
                    out[n][oc][oh][ow] = bias[oc];
                    {% else %}
                    out[n][oc][oh][ow] = 0.0f;
                    {% endif %}
                }
            }
        }
        for (int64_t ic = 0; ic < {{ in_channels }}; ++ic) {
            int64_t group = ic / in_per_group;
            for (int64_t ih = 0; ih < {{ in_h }}; ++ih) {
                for (int64_t iw = 0; iw < {{ in_w }}; ++iw) {
                    {{ c_type }} value = input[n][ic][ih][iw];
                    for (int64_t kh = 0; kh < {{ k_h }}; ++kh) {
                        int64_t oh = ih * {{ stride_h }} - {{ pad_h }} + kh * {{ dil_h }};
                        if (oh < 0 || oh >= {{ out_h }}) {
                            continue;
                        }
                        for (int64_t kw = 0; kw < {{ k_w }}; ++kw) {
                            int64_t ow = iw * {{ stride_w }} - {{ pad_w }} + kw * {{ dil_w }};
                            if (ow < 0 || ow >= {{ out_w }}) {
                                continue;
                            }
                            for (int64_t oc = 0; oc < out_per_group; ++oc) {
                                int64_t out_c = group * out_per_group + oc;
                                out[n][out_c][oh][ow] +=
                                    value * weight[ic][oc][kh][kw];
                            }
                        }
                    }
                }
            }
        }
    }
    {% else %}
    for (int64_t oc = 0; oc < {{ out_channels }}; ++oc) {
        for (int64_t oh = 0; oh < {{ out_h }}; ++oh) {
            for (int64_t ow = 0; ow < {{ out_w }}; ++ow) {
                {% if has_bias %}
                out[oc][oh][ow] = bias[oc];
                {% else %}
                out[oc][oh][ow] = 0.0f;
                {% endif %}
            }
        }
    }
    for (int64_t ic = 0; ic < {{ in_channels }}; ++ic) {
        int64_t group = ic / in_per_group;
        for (int64_t ih = 0; ih < {{ in_h }}; ++ih) {
            for (int64_t iw = 0; iw < {{ in_w }}; ++iw) {
                {{ c_type }} value = input[ic][ih][iw];
                for (int64_t kh = 0; kh < {{ k_h }}; ++kh) {
                    int64_t oh = ih * {{ stride_h }} - {{ pad_h }} + kh * {{ dil_h }};
                    if (oh < 0 || oh >= {{ out_h }}) {
                        continue;
                    }
                    for (int64_t kw = 0; kw < {{ k_w }}; ++kw) {
                        int64_t ow = iw * {{ stride_w }} - {{ pad_w }} + kw * {{ dil_w }};
                        if (ow < 0 || ow >= {{ out_w }}) {
                            continue;
                        }
                        for (int64_t oc = 0; oc < out_per_group; ++oc) {
                            int64_t out_c = group * out_per_group + oc;
                            out[out_c][oh][ow] +=
                                value * weight[ic][oc][kh][kw];
                        }
                    }
                }
            }
        }
    }
    {% endif %}
}
