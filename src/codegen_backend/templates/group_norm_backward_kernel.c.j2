{{ signature }}
    const int64_t batch = {{ batch }};
    const int64_t channels = {{ channels }};
    const int64_t spatial = {{ spatial_size }};
    const int64_t groups = {{ groups }};
    const int64_t channels_per_group = channels / groups;
    const {{ c_type }} *grad_ptr = &grad_output{{ grad_zero_indices }};
    const {{ c_type }} *input_ptr = &input{{ input_zero_indices }};
    const {{ c_type }} *mean_ptr = &mean{{ mean_zero_indices }};
    const {{ c_type }} *rstd_ptr = &rstd{{ rstd_zero_indices }};
    {{ c_type }} *out_ptr = &out{{ output_zero_indices }};
{% if has_weight %}
    const {{ c_type }} *weight_ptr = &weight{{ weight_zero_indices }};
{% endif %}
    for (size_t n = 0; n < batch; ++n) {
        for (size_t g = 0; g < groups; ++g) {
            const int64_t c_start = g * channels_per_group;
            {{ c_type }} mean = mean_ptr[n * groups + g];
            {{ c_type }} rstd = rstd_ptr[n * groups + g];
            {{ c_type }} sum1 = 0;
            {{ c_type }} sum2 = 0;
            for (size_t c = 0; c < channels_per_group; ++c) {
                const int64_t channel = c_start + c;
{% if has_weight %}
                {{ c_type }} w = weight_ptr[channel];
{% else %}
                {{ c_type }} w = 1;
{% endif %}
                const int64_t base = (n * channels + channel) * spatial;
                for (size_t s = 0; s < spatial; ++s) {
                    const int64_t idx = base + s;
                    {{ c_type }} dy = grad_ptr[idx];
                    {{ c_type }} dxhat = dy * w;
                    sum1 += dxhat;
                    sum2 += dxhat * (input_ptr[idx] - mean);
                }
            }
            const {{ c_type }} inv_group = ({{ c_type }})1 / ({{ c_type }})(channels_per_group * spatial);
            for (size_t c = 0; c < channels_per_group; ++c) {
                const int64_t channel = c_start + c;
{% if has_weight %}
                {{ c_type }} w = weight_ptr[channel];
{% else %}
                {{ c_type }} w = 1;
{% endif %}
                const int64_t base = (n * channels + channel) * spatial;
                for (size_t s = 0; s < spatial; ++s) {
                    const int64_t idx = base + s;
                    {{ c_type }} dy = grad_ptr[idx];
                    {{ c_type }} dxhat = dy * w;
                    {{ c_type }} term = (dxhat - sum1 * inv_group - (input_ptr[idx] - mean) * rstd * rstd * sum2 * inv_group);
                    out_ptr[idx] = term * rstd;
                }
            }
        }
    }
}
