{{ signature }}
  for (int64_t n = 0; n < {{ batch }}; ++n) {
    for (int64_t c = 0; c < {{ channels }}; ++c) {
      {{ c_type }} mean = running_mean[c];
      {{ c_type }} var = running_var[c];
      {{ c_type }} inv = {{ one_literal }} / sqrtf(var + {{ eps }});
{% if has_weight %}
      {{ c_type }} scale = weight[c];
{% else %}
      {{ c_type }} scale = {{ one_literal }};
{% endif %}
{% if has_bias %}
      {{ c_type }} offset = bias[c];
{% else %}
      {{ c_type }} offset = {{ zero_literal }};
{% endif %}
      for (int64_t i = 0; i < {{ inner_size }}; ++i) {
        int64_t idx = (n * {{ channels }} + c) * {{ inner_size }} + i;
        {{ c_type }} value = (({{ c_type }}*)input)[idx];
        (({{ c_type }}*)out)[idx] = (value - mean) * inv * scale + offset;
      }
    }
  }
}
