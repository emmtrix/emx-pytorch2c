{{ signature }}
    for (size_t n = 0; n < {{ batch }}; ++n) {
        for (size_t c = 0; c < {{ channels }}; ++c) {
            for (size_t ih = 0; ih < {{ in_h }}; ++ih) {
                for (size_t iw = 0; iw < {{ in_w }}; ++iw) {
                    out[n][c][ih][iw] = 0;
                }
            }
        }
    }
    for (size_t n = 0; n < {{ batch }}; ++n) {
        for (size_t c = 0; c < {{ channels }}; ++c) {
            for (size_t oh = 0; oh < {{ out_h }}; ++oh) {
                for (size_t ow = 0; ow < {{ out_w }}; ++ow) {
                    int64_t in_h_base = (int64_t)oh * {{ stride_h }} - {{ pad_h }};
                    int64_t in_w_base = (int64_t)ow * {{ stride_w }} - {{ pad_w }};
                    int64_t h_start = in_h_base;
                    int64_t w_start = in_w_base;
                    int64_t h_end = in_h_base + {{ k_h }};
                    int64_t w_end = in_w_base + {{ k_w }};
                    if (h_start < 0) {
                        h_start = 0;
                    }
                    if (w_start < 0) {
                        w_start = 0;
                    }
                    if (h_end > {{ in_h }}) {
                        h_end = {{ in_h }};
                    }
                    if (w_end > {{ in_w }}) {
                        w_end = {{ in_w }};
                    }
                    if (h_end <= h_start || w_end <= w_start) {
                        continue;
                    }
                    int64_t divisor;
                    {% if has_divisor_override %}
                    divisor = {{ divisor_override }};
                    {% elif count_include_pad %}
                    divisor = {{ k_h }} * {{ k_w }};
                    {% else %}
                    divisor = (h_end - h_start) * (w_end - w_start);
                    {% endif %}
                    {{ c_type }} grad = grad_output[n][c][oh][ow] / ({{ c_type }})divisor;
                    for (size_t ih = (size_t)h_start; ih < (size_t)h_end; ++ih) {
                        for (size_t iw = (size_t)w_start; iw < (size_t)w_end; ++iw) {
                            out[n][c][ih][iw] += grad;
                        }
                    }
                }
            }
        }
    }
}
